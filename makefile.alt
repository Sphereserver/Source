SHELL   = /bin/bash

# Generic makefile
MARCH = -march=i686 -m32
OPTDEFAULT = -fno-omit-frame-pointer -ffast-math -fpermissive $(MARCH)
COPTDEFAULT = -fno-omit-frame-pointer -ffast-math $(MARCH)
OPT 	= -O0 -fno-expensive-optimizations $(OPTDEFAULT)
COPT	= -O0 -fno-expensive-optimizations $(COPTDEFAULT)
WARN	= -Wall -Wno-unknown-pragmas -Wno-invalid-offsetof -Wno-unused-but-set-variable -Wno-switch
CWARN	= -Wall -Wno-unknown-pragmas -Wno-unused-but-set-variable -Wno-switch -Wno-implicit-function-declaration

ifdef DBG
DEBUG	= -s -ggdb3
else
DEBUG	= -s
endif

# DB includes + libs
DBINCL	= -I/usr/include/mysql
DBLIBS	= -lmysqlclient

# Linux
INCLUDE	= -I../common $(DBINCL)
LIBS	= -dynamic -L/usr/lib -lpthread $(DBLIBS) -lrt -ldl
DEFNIX  = -D_LINUX

ifdef NIGHTLY
NIGHTLYDEFS = -D_NIGHTLYBUILD
# NIGHTLYDEFS = -D_NIGHTLYBUILD -DTHREAD_TRACK_CALLSTACK
endif

ifdef DBG
DEBUGDEFS = -D_DEBUG -DTHREAD_TRACK_CALLSTACK
DBGWARN = -Wno-unused-variable
# DEBUGDEFS = -D_DEBUG -D_PACKETDUMP -D_TESTEXCEPTION -DDEBUG_CRYPT_MSGS
endif

EXTRADEFS = -D_MTNETWORK
SVNDEFS = -D_SUBVERSION
DEFINES = -DGRAY_SVR -D_CONSOLE -D_REENTRANT $(DEFNIX) $(NIGHTLYDEFS) $(EXTRADEFS) $(DEBUGDEFS) $(SVNDEFS)

EXE	= spheresvr

CC	= g++
CCO	= gcc

NO	= -fno-rtti -fno-exceptions
EX	= -fexceptions -fnon-call-exceptions
SPECIAL = $(EX) $(DEBUG)

GITHASHCMD = "$(shell git log -1 HEAD --format=%h)"
GITREVISIONCMD = $(shell echo $(shell git rev-list --count HEAD) + 410 | bc)

PROF	= -pg
PIPE	= -pipe

SRC	:= 	CAccount.cpp \
		CBase.cpp \
		CChar.cpp \
		CCharact.cpp \
		CCharBase.cpp \
		CCharFight.cpp \
		CCharNPC.cpp \
		CCharNPCAct.cpp \
		CCharNPCPet.cpp \
		CCharNPCStatus.cpp \
		CCharSkill.cpp \
		CCharSpell.cpp \
		CCharStatus.cpp \
		CCharUse.cpp \
		CChat.cpp \
		CClient.cpp \
		CClientDialog.cpp \
		CClientEvent.cpp \
		CClientGMPage.cpp \
		CClientLog.cpp \
		CClientMsg.cpp \
		CClientTarg.cpp \
		CClientUse.cpp \
		CContain.cpp \
		CGMPage.cpp \
		CItem.cpp \
		CItemBase.cpp \
		CItemMulti.cpp \
		CItemMultiCustom.cpp \
		CItemShip.cpp \
		CItemSp.cpp \
		CItemStone.cpp \
		CItemVend.cpp \
		CLog.cpp \
		CObjBase.cpp \
		CPathFinder.cpp \
		CResource.cpp \
		CResourceCalc.cpp \
		CResourceDef.cpp \
		CSector.cpp \
		CServer.cpp \
		CServRef.cpp \
		CQuest.cpp \
		CWebPage.cpp \
		CWorld.cpp \
		CWorldImport.cpp \
		CWorldMap.cpp \
		graysvr.cpp \
		PingServer.cpp \
		UnixTerminal.cpp \
		../common/twofish/twofish2.cpp \
		../common/libev/wrapper_ev.c \
		../common/zlib/adler32.c \
		../common/zlib/compress.c \
		../common/zlib/crc32.c \
		../common/zlib/deflate.c \
		../common/zlib/gzclose.c \
		../common/zlib/gzlib.c \
		../common/zlib/gzread.c \
		../common/zlib/gzwrite.c \
		../common/zlib/infback.c \
		../common/zlib/inffast.c \
		../common/zlib/inflate.c \
		../common/zlib/inftrees.c \
		../common/zlib/trees.c \
		../common/zlib/uncompr.c \
		../common/zlib/zutil.c \
		../common/CArray.cpp \
		../common/CAtom.cpp \
		../common/CAssoc.cpp \
		../common/CDataBase.cpp \
		../common/CDatabaseLoader.cpp \
		../common/CEncrypt.cpp \
		../common/CExpression.cpp \
		../common/CException.cpp \
		../common/CacheableScriptFile.cpp \
		../common/CFile.cpp \
		../common/CFileList.cpp \
		../common/CGrayData.cpp \
		../common/CGrayInst.cpp \
		../common/CGrayMap.cpp \
		../common/CMD5.cpp \
		../common/CQueue.cpp \
		../common/CRect.cpp \
		../common/CRegion.cpp \
		../common/CResourceBase.cpp \
		../common/CScript.cpp \
		../common/CScriptObj.cpp \
		../common/CSectorTemplate.cpp \
		../common/CSocket.cpp \
		../common/CsvFile.cpp \
		../common/CTime.cpp \
		../common/CString.cpp \
		../common/CVarDefMap.cpp \
		../common/CVarFloat.cpp \
		../common/ListDefContMap.cpp \
		../common/graycom.cpp \
		../common/sqlite/SQLite.cpp \
		../common/sqlite/sqlite3.c \
		../sphere/mutex.cpp \
		../sphere/strings.cpp \
		../sphere/threads.cpp \
		../sphere/linuxev.cpp \
		../sphere/asyncdb.cpp \
		../sphere/ProfileData.cpp \
		../network/network.cpp \
		../network/packet.cpp \
		../network/send.cpp \
		../network/receive.cpp

O_FLAGS		= $(WARN) $(DBGWARN) $(PIPE) $(SPECIAL)
CO_FLAGS	= $(CWARN) $(DBGWARN) $(PIPE) $(SPECIAL)
C_FLAGS		= $(OPT) $(INCLUDE) $(DEFINES)
CC_FLAGS	= $(COPT) $(INCLUDE) $(DEFINES)


.PHONY:	all clean tidy

all:	$(EXE)

clean:	tidy
	rm -f *.o ../common/*.o ../common/mtrand/*.o ../common/twofish/*.o ../common/libev/*.o ../common/zlib/*.o ../common/sqlite/*.o ../sphere/*.o ../network/*.o ../tests/*.o $(EXE)

tidy:
	rm -f *~ *orig *bak *rej ../common/*~ ../common/*orig ../common*bak \
				 ../common/mtrand/*~ ../common/mtrand/*orig ../common/mtrand/*bak \
				 ../common/twofish/*~ ../common/twofish/*orig ../common/twofish/*bak \
				 ../common/libev/*~ ../common/libev/*orig ../common/libev/*bak \
				 ../common/zlib/*~ ../common/zlib/*orig ../common/zlib/*bak \
				 ../common/sqlite/*~ ../common/sqlite/*orig ../common/sqlite/*bak \
				 ../sphere/*~ ../sphere/*orig ../sphere/*bak \
				 ../network/*~ ../network/*orig ../network/*bak \
				 ../tests/*~ ../tests/*orig ../tests/*bak

tags:	$(SRC)
	ctags $(SRC)

git:
	@echo '#define __GITHASH__ ${GITHASHCMD}' > ../common/version/GitRevision.h
	@echo '#define __GITREVISION__ ${GITREVISIONCMD}' >> ../common/version/GitRevision.h

gray:	$(SRC:.cpp=.o) $(SRC:.c=.co)


flags:  
	@echo "Compiler Flags: $(CC) -c $(O_FLAGS) $(C_FLAGS)"

$(EXE): git flags gray
	@$(CC) $(O_FLAGS) $(C_FLAGS) -o $(EXE) *.o ../common/*.o ../common/twofish/*.o ../common/libev/*.o ../common/zlib/*.o ../common/sqlite/*.o ../sphere/*.o ../network/*.o $(LIBS)

%.o:	%.cpp
	@echo " Compiling $<"
	@$(CC) -c $(O_FLAGS) $(C_FLAGS) $< -o $@

%.co:	%.c
	@echo " Compiling $<"
	@$(CCO) -c $(CO_FLAGS) $(CC_FLAGS) $< -o $(@:.co=.o)

distDBG:	
	@rm -f ./Build/SphereSvr[Linux][DEBUG].tar.gz
	@tar cvzf ./Build/SphereSvr[Linux][DEBUG].tar.gz $(EXE)

dist:
	@rm -f ./Build/SphereSvr[Linux].tar.gz
	@tar cvzf ./Build/SphereSvr[Linux].tar.gz $(EXE)

